# FIXME: Add more clear job description and name
name: Migration secrets and variables
run-name: "Migration secrets and variables ${{ inputs.target_repo }}"
on:
  workflow_dispatch:
    inputs:
      target_owner:
        type: string
        description: 'The target organization owner'
        required: true
        default: 'adskyiproger'
      target_repo_name:
        type: string
        description: 'The target infrastructure repository'
        required: true
        default: 'opencrvs-infrastructure'

env:
  SOURCE_REPO: ${{ github.repository }}
  TARGET_REPO: ${{ inputs.target_owner }}/${{ inputs.target_repo_name }}
  # FIXME: Use a separate token with appropriate permissions
  GH_TOKEN: ${{ secrets.MIGRATION_GH_TOKEN }}
jobs:
  repository-configuration-migration:
    name: Repository secrets and variables
    runs-on: ubuntu-latest
    outputs:
      secrets: ${{ steps.summary.outputs.secrets }}
      variables: ${{ steps.summary.outputs.variables }}
      environments: ${{ steps.summary.outputs.environments }}
    steps:
      - name: Summary
        id: summary
        run: |
          # Repository-level counts
          SOURCE_SECRETS=$(gh api repos/$SOURCE_REPO/actions/secrets --jq '.secrets')
          SOURCE_SECRETS_COUNT=$(echo "$SOURCE_SECRETS" | jq 'length')
          SOURCE_SECRETS_NAMES=$(echo "$SOURCE_SECRETS" | jq -r '.[].name' | sort)
          echo secrets=$SOURCE_SECRETS_NAMES >> $GITHUB_OUTPUT

          SOURCE_VARS=$(gh api repos/$SOURCE_REPO/actions/variables --jq '.variables')
          SOURCE_VARS_COUNT=$(echo "$SOURCE_VARS" | jq 'length')
          SOURCE_VARS_NAMES=$(echo "$SOURCE_VARS" | jq -r '.[].name' | sort)
          echo variables=$SOURCE_VARS_NAMES >> $GITHUB_OUTPUT

          SOURCE_ENVS=$(gh api repos/$SOURCE_REPO/environments --jq '.environments | map(.name)')
          SOURCE_ENVS_COUNT=$(echo "$SOURCE_ENVS" | jq ' . | length')
          echo environments=$SOURCE_ENVS >> $GITHUB_OUTPUT

          TARGET_SECRETS=$(gh api repos/$TARGET_REPO/actions/secrets --jq '.secrets')
          TARGET_SECRETS_COUNT=$(echo "$TARGET_SECRETS" | jq 'length')
          TARGET_SECRETS_NAMES=$(echo "$TARGET_SECRETS" | jq -r '.[].name' | sort)

          TARGET_VARS=$(gh api repos/$TARGET_REPO/actions/variables --jq '.variables')
          TARGET_VARS_COUNT=$(echo "$TARGET_VARS" | jq 'length')
          TARGET_VARS_NAMES=$(echo "$TARGET_VARS" | jq -r '.[].name' | sort)

          TARGET_ENVS_COUNT=$(gh api repos/$TARGET_REPO/environments --jq '.total_count')
          echo "
          ## Source repository: $SOURCE_REPO

          - ðŸŒ Number of environments: $SOURCE_ENVS_COUNT
          - ðŸ” Number of secrets (repo scope): $SOURCE_SECRETS_COUNT
          - ðŸ“‹ Number of variables (repo scope): $SOURCE_VARS_COUNT

          ## Target repository: $TARGET_REPO
          - ðŸŒ Number of environments: $TARGET_ENVS_COUNT
          - ðŸ” Number of secrets (repo scope): $TARGET_SECRETS_COUNT
          - ðŸ“‹ Number of variables (repo scope): $TARGET_VARS_COUNT
          " >> $GITHUB_STEP_SUMMARY
      - name: "Export variables from ${{ github.repository }}"
        id: export-repo-variables
        run: |
            jq -n -r \
            '
                [${{ toJSON(vars) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > variables.env
      - name: Import variables to ${{ inputs.target_owner }}/${{ inputs.target_repo_name }}
        run: |
          echo "ðŸ“Š Importing variables to $TARGET_REPO"
          # Import each variable
          while read line; do
            [ -z "$line" ] && continue # Skip empty lines
            KEY=$(echo "$line" | cut -d'=' -f1)
            VALUE=$(echo "$line" | cut -d'=' -f2-)
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting variable: $KEY"
            gh variable set "$KEY" --body "$DECODED_VALUE" --repo "$TARGET_REPO"
          done < variables.env
      - name: Export repository secrets
        id: export-repo-secrets
        run: |
            jq -n -r \
            '
                [${{ toJSON(secrets) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > secrets.env
      - name: Import secrets to ${{ inputs.target_owner }}/${{ inputs.target_repo_name }}
        run: |
          echo "ðŸ“Š Importing secrets to $TARGET_REPO"
          # Import each secret
          while read line; do
            [ -z "$line" ] && continue # Skip empty lines
            KEY=$(echo "$line" | cut -d'=' -f1)
            echo $KEY | grep -iq github && continue # Skip GitHub token secrets
            VALUE=$(echo "$line" | cut -d'=' -f2-)
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting secret: $KEY"
            gh secret set "$KEY" --body "$DECODED_VALUE" --repo "$TARGET_REPO"
          done < secrets.env

  environment-secrets-migration:
    runs-on: ubuntu-latest
    needs: repository-configuration-migration
    strategy:
      max-parallel: 1  # Ensure jobs run one by one
      fail-fast: true  # Stop on first failure
      matrix:
        # environment: ${{ fromJSON(needs.repository-configuration-migration.outputs.environments) }}
        # FIXME: Temporary hardcode until we have multiple environments to test
        environment: 
          - swarm-to-k8s # THIS IS REAL ENV NAME IN FARAJALAND
    environment: ${{ matrix.environment }}
    name: ${{ matrix.environment }} environment
    env:
      SECRETS_LIST: ${{ needs.repository-configuration-migration.outputs.secrets }}
      VARS_LIST: ${{ needs.repository-configuration-migration.outputs.variables }}
      ENVIRONMENT: ${{ matrix.environment }}
    steps:
      - name: "Export variables from ${{ github.repository }}/${{ matrix.environment }}"
        run: |
            jq -n -r \
            '
                [${{ toJSON(vars) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > variables.env
      - name: "Export secrets from ${{ github.repository }}/${{ matrix.environment }}"
        run: |
            jq -n -r \
            '
                [${{ toJSON(secrets) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > secrets.env
      - name: Create environment in ${{ inputs.target_owner }}/${{ inputs.target_repo_name }} if not exists
        run: |
          if gh api repos/$TARGET_REPO/environments/$ENVIRONMENT 2>/dev/null; then
            echo "âœ… Environment '$ENVIRONMENT' already exists"
          else
            echo "ðŸ”§ Creating environment '$ENVIRONMENT'..."
            gh api repos/$TARGET_REPO/environments/$ENVIRONMENT -X PUT
          fi
      - name: Import variables to ${{ inputs.target_owner }}/${{ inputs.target_repo_name }} in ${{ matrix.environment }} environment
        id: import-environment-variables
        run: |
          echo "ðŸ“Š Importing variables to $TARGET_REPO"
          # Import each variable

          SKIPPED_KEYS=()
          while read line; do
            [ -z "$line" ] && continue # Skip empty lines
            KEY=$(echo "$line" | cut -d'=' -f1)
            VALUE=$(echo "$line" | cut -d'=' -f2-)
            # TODO: Add whitelist, e/g ACTIVATE_USERS might be present at repo level
            echo $VARS_LIST | grep -q "$KEY" && SKIPPED_KEYS+=("$KEY") && continue
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting variable: $KEY"
            gh variable set "$KEY" --body "$DECODED_VALUE" --env "$ENVIRONMENT" --repo "$TARGET_REPO"            
          done < variables.env
          echo "âš ï¸ Skipped variables already present at repository level: ${SKIPPED_KEYS[*]}"
          echo "SKIPPED_KEYS=${SKIPPED_KEYS[*]}" >> $GITHUB_OUTPUT
      - name: Import secrets to ${{ inputs.target_owner }}/${{ inputs.target_repo_name }} in ${{ matrix.environment }} environment
        id: import-environment-secrets
        run: |
          echo "ðŸ“Š Importing secrets to $TARGET_REPO"
          # Import each secret

          SKIPPED_KEYS=()
          while read line; do
            [ -z "$line" ] && continue # Skip empty lines
            KEY=$(echo "$line" | cut -d'=' -f1)
            VALUE=$(echo "$line" | cut -d'=' -f2-)
            # TODO: Add whitelist, e/g ACTIVATE_USERS might be present at repo level
            echo $KEY | grep -iq github && continue # Skip GitHub token secrets
            echo $SECRETS_LIST | grep -q "$KEY" && SKIPPED_KEYS+=("$KEY") && continue
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting secret: $KEY"
            gh secret set "$KEY" --body "$DECODED_VALUE" --env "$ENVIRONMENT" --repo "$TARGET_REPO"
          done < secrets.env
          echo "âš ï¸ Skipped secrets already present at repository level: ${SKIPPED_KEYS[*]}"
          echo "SKIPPED_KEYS=${SKIPPED_KEYS[*]}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          {
          echo "
          ## Summary for environment: $ENVIRONMENT
          - ðŸ“‹ Number of variables (repo scope): $(wc -l variables.env)
          - ðŸ” Number of secrets (repo scope): $(wc -l secrets.env)
          - âš ï¸ Skipped variables (already exist at repo level):
          "
          printf "   - %s\n" ${{ steps.import-environment-variables.outputs.SKIPPED_KEYS }}
          echo "- âš ï¸ Skipped secrets (already exist at repo level):"
          printf "   - %s\n" ${{ steps.import-environment-secrets.outputs.SKIPPED_KEYS }}
          } >> $GITHUB_STEP_SUMMARY
  bootstrap-self-hosted-runner:
    name: Bootstrap self-hosted runner on target repo
    needs: repository-configuration-migration
    strategy:
      max-parallel: 1  # Ensure jobs run one by one
      fail-fast: true  # Stop on first failure
      matrix:
        # environment: ${{ fromJSON(needs.repository-configuration-migration.outputs.environments) }}
        # FIXME: Temporary hardcode until we have multiple environments to test
        environment: 
          - swarm-to-k8s # THIS IS REAL ENV NAME IN FARAJALAND
    environment: ${{ matrix.environment }}
    name: ${{ matrix.environment }} environment
    runs-on: ubuntu-24.04
    outputs:
      outcome: ${{ steps.deploy.outcome }}
    timeout-minutes: 60
    steps:
      - name: Clone country config resource package
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}
          path: './${{ github.event.repository.name }}'

      - name: Set variables for ansible
        id: ansible-variables
        run: |
          JSON_WITH_NEWLINES=$(cat<<EOF
            ${{ toJSON(env) }}
          EOF)
          JSON_WITHOUT_NEWLINES=$(echo $JSON_WITH_NEWLINES | jq -R -c .)
          echo "EXTRA_VARS=$JSON_WITHOUT_NEWLINES" >> $GITHUB_OUTPUT
        env:
          manager_production_server_ip: ${{ vars.SSH_HOST }}
          ansible_user: ${{ secrets.SSH_USER }}
          target_repo_owner: ${{ inputs.target_owner }}
          target_repo_name: ${{ inputs.target_repo_name }}
          migration_token: ${{ secrets.MIGRATION_RUNNER_TOKEN }}
          environment: ${{ matrix.environment }}
      - name: Read known hosts
        run: |
          cd ${{ github.event.repository.name }}
          echo "KNOWN_HOSTS<<EOF" >> $GITHUB_ENV
          sed -i -e '$a\' ./infrastructure/known-hosts
          cat ./infrastructure/known-hosts >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ env.KNOWN_HOSTS }}
      - name: Run playbook
        uses: dawidd6/action-ansible-playbook@v2.8.0
        env:
          ANSIBLE_PERSISTENT_COMMAND_TIMEOUT: 10
          ANSIBLE_SSH_TIMEOUT: 10
          ANSIBLE_SSH_RETRIES: 5
        with:
          playbook: self-hosted-runner.yml
          directory: ${{ github.event.repository.name }}/infrastructure/server-setup
          options: |
            --verbose
            --inventory inventory/${{ inputs.environment }}.yml
            ${{ inputs.tag != 'all' && format('--tags={0}', inputs.tag) || ''}}
            --extra-vars ""${{ steps.ansible-variables.outputs.EXTRA_VARS }}""
