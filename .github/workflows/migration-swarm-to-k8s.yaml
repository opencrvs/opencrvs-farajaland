# FIXME: Add more clear job description and name
name: Migration secrets and variables
run-name: "Migration secrets and variables ${{ inputs.target_repo }}"
on:
  workflow_dispatch:
    inputs:
      target_repo:
        type: string
        description: 'The target infrastructure repository to use for migration'
        required: true
        default: 'adskyiproger/opencrvs-infrastructure'

env:
  SOURCE_REPO: ${{ github.repository }}
  TARGET_REPO: ${{ inputs.target_repo }}
  # FIXME: Use a separate token with appropriate permissions
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
jobs:
  repository-configuration-migration:
    name: Repository secrets and variables
    runs-on: ubuntu-latest
    outputs:
      secrets: ${{ steps.summary.outputs.secrets }}
      variables: ${{ steps.summary.outputs.variables }}
      environments: ${{ steps.summary.outputs.environments }}
    steps:
      - name: Summary
        id: summary
        run: |
          # Repository-level counts
          SOURCE_SECRETS=$(gh api repos/$SOURCE_REPO/actions/secrets --jq '.secrets')
          SOURCE_SECRETS_COUNT=$(echo "$SOURCE_SECRETS" | jq 'length')
          SOURCE_SECRETS_NAMES=$(echo "$SOURCE_SECRETS" | jq -r '.[].name' | sort)
          echo secrets=$SOURCE_SECRETS_NAMES >> $GITHUB_OUTPUT

          SOURCE_VARS=$(gh api repos/$SOURCE_REPO/actions/variables --jq '.variables')
          SOURCE_VARS_COUNT=$(echo "$SOURCE_VARS" | jq 'length')
          SOURCE_VARS_NAMES=$(echo "$SOURCE_VARS" | jq -r '.[].name' | sort)
          echo variables=$SOURCE_VARS_NAMES >> $GITHUB_OUTPUT

          SOURCE_ENVS=$(gh api repos/$SOURCE_REPO/environments --jq '.environments | map(.name)')
          SOURCE_ENVS_COUNT=$(echo "$SOURCE_ENVS" | jq ' . | length')
          echo environments=$SOURCE_ENVS >> $GITHUB_OUTPUT

          TARGET_SECRETS=$(gh api repos/$TARGET_REPO/actions/secrets --jq '.secrets')
          TARGET_SECRETS_COUNT=$(echo "$TARGET_SECRETS" | jq 'length')
          TARGET_SECRETS_NAMES=$(echo "$TARGET_SECRETS" | jq -r '.[].name' | sort)

          TARGET_VARS=$(gh api repos/$TARGET_REPO/actions/variables --jq '.variables')
          TARGET_VARS_COUNT=$(echo "$TARGET_VARS" | jq 'length')
          TARGET_VARS_NAMES=$(echo "$TARGET_VARS" | jq -r '.[].name' | sort)

          TARGET_ENVS_COUNT=$(gh api repos/$TARGET_REPO/environments --jq '.total_count')
          echo "
          ## Source repository: $SOURCE_REPO

          - ðŸŒ Number of environments: $SOURCE_ENVS_COUNT
          - ðŸ” Number of secrets (repo scope): $SOURCE_SECRETS_COUNT
          - ðŸ“‹ Number of variables (repo scope): $SOURCE_VARS_COUNT

          ## Target repository: $TARGET_REPO
          - ðŸŒ Number of environments: $TARGET_ENVS_COUNT
          - ðŸ” Number of secrets (repo scope): $TARGET_SECRETS_COUNT
          - ðŸ“‹ Number of variables (repo scope): $TARGET_VARS_COUNT
          " >> $GITHUB_STEP_SUMMARY
      - name: "Export variables from ${{ github.repository }}"
        id: export-repo-variables
        run: |
            jq -n -r \
            '
                [${{ toJSON(vars) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > variables.env
      - name: Import variables to ${{ inputs.target_repo }}
        run: |
          echo "ðŸ“Š Importing variables to $TARGET_REPO"
          # Import each variable
          while IFS='=' read -r KEY VALUE; do
            [ -z "$KEY" ] && continue
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting variable: $KEY"
            gh variable set "$KEY" --body "$DECODED_VALUE" --repo "$TARGET_REPO"
          done < variables.env
      - name: Export repository secrets
        id: export-repo-secrets
        run: |
            jq -n -r \
            '
                [${{ toJSON(secrets) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > secrets.env
      # - name: Trigger secrets import in ${{ inputs.target_repo }}
      #   env:
      #       GH_TOKEN: ${{ secrets.MIGRATION_GH_TOKEN }}
      #   run: |
      #     gh api repos/${{ inputs.target_repo }}/dispatches \
      #       --method POST \
      #       -f event_type=import-config \
      #       -F client_payload[data_type]="secrets" \
      #       -F client_payload[data]='${{ steps.export-repo-secrets.outputs.repository_secrets }}'

  environment-secrets-migration:
    runs-on: ubuntu-latest
    needs: repository-configuration-migration
    strategy:
      max-parallel: 1  # Ensure jobs run one by one
      fail-fast: true  # Stop on first failure
      matrix:
        # environment: ${{ fromJSON(needs.repository-configuration-migration.outputs.environments) }}
        # FIXME: Temporary hardcode until we have multiple environments to test
        environment: 
          - development
    environment: ${{ matrix.environment }}
    name: ${{ matrix.environment }} environment
    env:
      SECRETS_LIST: ${{ needs.repository-configuration-migration.outputs.secrets }}
      VARS_LIST: ${{ needs.repository-configuration-migration.outputs.variables }}
      ENVIRONMENT: ${{ matrix.environment }}
    steps:
      - name: "Export variables from ${{ github.repository }}/${{ matrix.environment }}"
        run: |
            jq -n -r \
            '
                [${{ toJSON(vars) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > variables.env
  #     - name: Export repository secrets
  #       id: export-repo-secrets
  #       run: |
  #           EXPORT_JSON=$(jq -n -r '
  #               [${{ toJSON(secrets) }}] 
  #               | add
  #               | with_entries(.value |= @base64)
  #               | to_entries[] 
  #               | "\(.key)=\(.value)"
  #           ' | base64 -w 0)
  #           echo "::add-mask::$EXPORT_JSON"
  #           echo "repository_secrets=$EXPORT_JSON" >> $GITHUB_OUTPUT
      - name: Create environment in ${{ inputs.target_repo }} if not exists
        run: |
          if gh api repos/$TARGET_REPO/environments/$ENVIRONMENT 2>/dev/null; then
            echo "âœ… Environment '$ENVIRONMENT' already exists"
          else
            echo "ðŸ”§ Creating environment '$ENVIRONMENT'..."
            gh api repos/$TARGET_REPO/environments/$ENVIRONMENT -X PUT
          fi
      - name: Import variables to ${{ inputs.target_repo }} in ${{ matrix.environment }} environment
        run: |
          echo "ðŸ“Š Importing variables to $TARGET_REPO"
          # Import each variable
          cc=0
          while read line; do
            [ -z "$line" ] && continue # Skip empty lines
            KEY=$(echo "$line" | cut -d'=' -f1)
            VALUE=$(echo "$line" | cut -d'=' -f2-)
            # TODO: Add whitelist, e/g ACTIVATE_USERS might be present at repo level
            SKIPPED_KEYS=""
            echo $VARS_LIST | grep -q "$KEY" && SKIPPED_KEYS+=$KEY && continue
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting variable: $KEY"
            gh variable set "$KEY" --body "$DECODED_VALUE" --env "$ENVIRONMENT" --repo "$TARGET_REPO"
            echo "+ done"
            ((cc++))
          done < variables.env
          echo "
          ## Target repository: $TARGET_REPO - environment: $ENVIRONMENT

          Import summary:
          - ðŸ” Number of secrets: $TARGET_SECRETS_COUNT
          - ðŸ“‹ Number of variables: $TARGET_VARS_COUNT
          - Skipped variables (already present at repo level): $SKIPPED_KEYS
          " >> $GITHUB_STEP_SUMMARY
      # - name: Trigger secrets import in ${{ inputs.target_repo }}
      #   env:
      #       GH_TOKEN: ${{ secrets.MIGRATION_GH_TOKEN }}
      #       ENVIRONMENT: ${{ matrix.environment }}
      #   run: |
      #     gh api repos/${{ inputs.target_repo }}/dispatches \
      #       --method POST \
      #       -f event_type=import-config \
      #       -F client_payload[data_type]="secrets" \
      #       -F client_payload[data]='${{ steps.export-repo-secrets.outputs.repository_secrets }}'
