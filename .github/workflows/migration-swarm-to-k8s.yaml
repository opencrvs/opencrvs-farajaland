name: Migration secrets and variables
run-name: "Migration secrets and variables ${{ inputs.target_repo }}"
on:
  workflow_dispatch:
    inputs:
      target_repo:
        type: string
        description: 'The target infrastructure repository to use for migration'
        required: true
        default: 'adskyiproger/opencrvs-infrastructure'

jobs:
  repository-configuration-migration:
    name: Repository Configuration Migration
    runs-on: ubuntu-latest
    outputs:
      variables-list: "<variables-list>"
      secrets-list: "<secrets-list>"
    steps:
      - name: "Export repository variables from ${{ github.repository }}"
        id: export-repo-variables
        run: |
            jq -n -r \
            '
                [${{ toJSON(vars) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' > variables.env

      - name: Import variables
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: ${{ inputs.target_repo }}
        run: |
          echo "ðŸ“Š Importing variables to ${ENVIRONMENT:-repository level}..."
          # Import each variable
          while IFS='=' read -r KEY VALUE; do
            [ -z "$KEY" ] && continue
            DECODED_VALUE=$(echo "$VALUE" | base64 -d)
            echo "  âœ“ Setting variable: $KEY"
            if [ -z "$ENVIRONMENT" ]; then
              gh variable set "$KEY" --body "$DECODED_VALUE" --repo "$REPO"
            else
              gh variable set "$KEY" --body "$DECODED_VALUE" --env "$ENVIRONMENT" --repo "$REPO"
            fi
          done < variables.env
      - name: Export repository secrets
        id: export-repo-secrets
        run: |
            EXPORT_JSON=$(jq -n -r \
            '
                [${{ toJSON(secrets) }}] 
                | add
                | with_entries(.value |= @base64)
                | to_entries[] 
                | "\(.key)=\(.value)"
            ' | base64 -w 0)
            echo "::add-mask::$EXPORT_JSON"
            echo "repository_secrets=$EXPORT_JSON" >> $GITHUB_OUTPUT
      # - name: Trigger secrets import in ${{ inputs.target_repo }}
      #   env:
      #       GH_TOKEN: ${{ secrets.MIGRATION_GH_TOKEN }}
      #   run: |
      #     gh api repos/${{ inputs.target_repo }}/dispatches \
      #       --method POST \
      #       -f event_type=import-config \
      #       -F client_payload[data_type]="secrets" \
      #       -F client_payload[data]='${{ steps.export-repo-secrets.outputs.repository_secrets }}'

  # environment-secrets-migration:
  #   name: Repository Secrets Migration
  #   runs-on: ubuntu-latest
  #   strategy:
  #     max-parallel: 1  # Ensure jobs run one by one
  #     fail-fast: true  # Stop on first failure
  #     matrix:
  #       environment:
  #         - aaa
  #   environment: ${{ matrix.environment }}
  #   steps:
  #     - name: Export repository variables
  #       id: export-repo-variables
  #       run: |
  #           EXPORT_JSON=$(jq -n -r '
  #               [${{ toJSON(vars) }}] 
  #               | add
  #               | with_entries(.value |= @base64)
  #               | to_entries[] 
  #               | "\(.key)=\(.value)"
  #           ' | base64 -w 0)
  #           echo "::add-mask::$EXPORT_JSON"
  #           echo "repository_variables=$EXPORT_JSON" >> $GITHUB_OUTPUT
  #     - name: Export repository secrets
  #       id: export-repo-secrets
  #       run: |
  #           EXPORT_JSON=$(jq -n -r '
  #               [${{ toJSON(secrets) }}] 
  #               | add
  #               | with_entries(.value |= @base64)
  #               | to_entries[] 
  #               | "\(.key)=\(.value)"
  #           ' | base64 -w 0)
  #           echo "::add-mask::$EXPORT_JSON"
  #           echo "repository_secrets=$EXPORT_JSON" >> $GITHUB_OUTPUT
  #     - name: Trigger variables import in ${{ inputs.target_repo }}
  #       env:
  #           GH_TOKEN: ${{ secrets.MIGRATION_GH_TOKEN }}
  #           ENVIRONMENT: ${{ matrix.environment }}
  #       run: |
  #         gh api repos/${{ inputs.target_repo }}/dispatches \
  #           --method POST \
  #           -f event_type=import-config \
  #           -F client_payload[data_type]="variables" \
  #           -F client_payload[data]='${{ steps.export-repo-variables.outputs.repository_variables }}'
      # - name: Trigger secrets import in ${{ inputs.target_repo }}
      #   env:
      #       GH_TOKEN: ${{ secrets.MIGRATION_GH_TOKEN }}
      #       ENVIRONMENT: ${{ matrix.environment }}
      #   run: |
      #     gh api repos/${{ inputs.target_repo }}/dispatches \
      #       --method POST \
      #       -f event_type=import-config \
      #       -F client_payload[data_type]="secrets" \
      #       -F client_payload[data]='${{ steps.export-repo-secrets.outputs.repository_secrets }}'
