# How to use this workflow:
##################################################################
# Workflow should be triggered manually from release branch
# environment: Name of the environment to create
# core_image_tag: OpenCRVS core image tag
# countryconfig_image_tag: OpenCRVS country config image tag
name: Release - Provision Environment
run-name: Provision ${{ inputs.environment }} release environment
on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment, e/g v19 will create v19.opencrvs.dev"
                required: true
            release_branch:
                description: "Branch for workflows"
                required: false
            core_image_tag:
                description: "Core tag (default: release_branch)"
                required: false
                type: string
            countryconfig_image_tag:
                description: "Country config tag (default: release_branch)"
                required: false
                type: string

jobs:
    release-provision-environment:
        runs-on: ubuntu-latest
        environment: ${{ inputs.environment }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Set defaults
              id: setvars
              run: |
                core="${{ inputs.core_image_tag }}"
                config="${{ inputs.countryconfig_image_tag }}"
                release="${{ inputs.environment }}"
                echo "core_tag=${core:-$release}" >> $GITHUB_OUTPUT
                echo "config_tag=${config:-$release}" >> $GITHUB_OUTPUT
            - name: Fail if not on release branch
              run: |
                echo "Current ref name: ${{ github.ref_name }}"
                echo "Current ref: ${{ github.ref }}"
                if [[ "${{ github.ref }}" != refs/heads/release/* ]]; then
                echo "‚ùå This workflow must be run from a release/* branch."
                exit 1
                fi
            - name: Create server ${{ vars.COUNTRY_NAME }}-${{ inputs.environment }} on Hetzner
              uses: ./.github/actions/run-workflow
              with:
                workflow: dummy-create-server.yml
                # workflow: create-hetzner-server.yml
                args: -f environment=${{ inputs.environment }}
                token: ${{ secrets.GH_TOKEN }}
                ref: ${{ inputs.release_branch }}
            - name: Run provision server 
              uses: ./.github/actions/run-workflow
              with:
                # workflow: provision.yml
                workflow: dummy-provision.yml
                args: -f environment=${{ inputs.environment }}
                token: ${{ secrets.GH_TOKEN }}
                ref: ${{ inputs.release_branch }}
            - name: Run deployment on ${{ inputs.environment }}
              uses: ./.github/actions/run-workflow
              with:
                workflow: dummy-deploy.yml
                args: |
                  -f environment=${{ inputs.environment }} \
                  -f core-image-tag=${{ steps.setvars.outputs.core_tag }} \
                  -f countryconfig-image-tag=${{ steps.setvars.outputs.config_tag }}
                token: ${{ secrets.GH_TOKEN }}
                ref: ${{ inputs.release_branch }}
            - name: Seeding data to ${{ inputs.environment }}
              uses: ./.github/actions/run-workflow
              with:
                workflow: dummy-seed.yml
                args: |
                  -f environment=${{ inputs.environment }} \
                  -f core-image-tag=${{ steps.setvars.outputs.core_tag }}
                token: ${{ secrets.GH_TOKEN }}
                ref: ${{ inputs.release_branch }}
