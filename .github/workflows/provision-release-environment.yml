name: Release - Provision Environment
run-name: Provision ${{ inputs.release_version }} release environment
on:
    workflow_dispatch:
        inputs:
            release_version:
                description: "Release version to deploy in format vX.Y.Z"
                required: true
            core_image_tag:
                description: Core image tag (if empty it will be set to release_version)
                required: false
                type: string
            countryconfig_image_tag:
                description: Country config image tag (if empty it will be set to release_version)
                required: false
                type: string
    workflow_call:
        inputs:
            release_version:
                type: string
                description: Environment to deploy to
                required: true
            core_image_tag:
                description: Core image tag (if empty it will be set to release_version)
                required: false
                type: string
            country_config_version:
                description: Country config image tag (if empty it will be set to release_version)
                required: false
                type: string
jobs:
    release-provision-environment:
        runs-on: ubuntu-latest
        environment: ${{ inputs.release_version }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Set defaults
              id: setvars
              run: |
                core="${{ inputs.core_image_tag }}"
                config="${{ inputs.countryconfig_image_tag }}"
                release="${{ inputs.release_version }}"
                echo "core_tag=${core:-$release}" >> $GITHUB_OUTPUT
                echo "config_tag=${config:-$release}" >> $GITHUB_OUTPUT
            - name: Create server ${{ vars.COUNTRY_NAME }}-${{ inputs.release_version }} on Hetzner
              uses: ./.github/actions/run-workflow
              with:
                # workflow: dummy-create-server.yml
                workflow: create-hetzner-server.yml
                args: -f environment=${{ inputs.release_version }}
                token: ${{ secrets.GH_TOKEN }}
            - name: Run provision server 
              uses: ./.github/actions/run-workflow
              with:
                workflow: provision.yml
                # workflow: dummy-provision.yml
                args: -f environment=${{ inputs.release_version }}
                token: ${{ secrets.GH_TOKEN }}

            - name: Run deployment on ${{ inputs.release_version }}
              uses: ./.github/actions/run-workflow
              with:
                workflow: dummy-deploy.yml
                args: |
                  -f environment=${{ inputs.release_version }} \
                  -f core-image-tag=${{ steps.setvars.outputs.core_tag }} \
                  -f countryconfig-image-tag=${{ steps.setvars.outputs.config_tag }}
                token: ${{ secrets.GH_TOKEN }}
            - name: Seeding data to ${{ inputs.release_version }}
              uses: ./.github/actions/run-workflow
              with:
                workflow: dummy-seed.yml
                args: |
                  -f environment=${{ inputs.release_version }} \
                  -f core-image-tag=${{ steps.setvars.outputs.core_tag }}
                token: ${{ secrets.GH_TOKEN }}
